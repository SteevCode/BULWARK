<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bulwark - Settings</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root{
    --bg:#0f172a;--card:rgba(30,41,59,0.92);
    --core:#3b82f6;--time:#fb923c;--privacy:#a78bfa;--block:#ef4444;--advanced:#f59e0b;--import:#10b981;
    --text:#f8fafc;--muted:#94a3b8;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;position:relative}
  body::before{content:"";position:absolute;inset:0;background:linear-gradient(45deg,#1e3a8a,#1e40af,#3b82f6,#1e40af);background-size:400%;animation:flow 15s ease infinite;opacity:0.4}
  @keyframes flow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .container{max-width:1200px;margin:40px auto;background:var(--card);border-radius:24px;overflow:hidden;
    box-shadow:0 20px 60px rgba(0,0,0,.7);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.15);position:relative}
  header{background:linear-gradient(135deg,rgba(30,60,140,.9),rgba(20,40,100,.9));padding:60px 30px;text-align:center;position:relative;overflow:hidden}
  header::before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(59,130,246,.5),transparent 60%);animation:pulse 8s infinite}
  @keyframes pulse{0%,100%{opacity:0.4}50%{opacity:0.7}}
  h1{font-size:3.2rem;font-weight:800;background:linear-gradient(135deg,#fff,#c0d6ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
    text-shadow:0 0 40px rgba(255,255,255,.5);animation:glow 4s ease-in-out infinite alternate}
  @keyframes glow{from{text-shadow:0 0 20px rgba(255,255,255,.4)}to{text-shadow:0 0 60px rgba(255,255,255,.8)}}
  p{font-size:1.3rem;opacity:0.9;margin-top:12px}
  .tabs{display:flex;background:rgba(255,255,255,.08);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.15);flex-wrap:wrap}
  .tab-btn{padding:20px 30px;background:none;border:none;color:var(--muted);font-weight:600;cursor:pointer;transition:all .35s;flex:1;display:flex;align-items:center;justify-content:center;gap:12px}
  .tab-btn:hover{color:var(--text);background:rgba(255,255,255,.15)}
  .tab-btn.active{color:white;font-weight:700;border-bottom:4px solid white;position:relative}
  .tab-btn[data-tab="core"].active{border-bottom-color:var(--core)}
  .tab-btn[data-tab="time"].active{border-bottom-color:var(--time)}
  .tab-btn[data-tab="privacy"].active{border-bottom-color:var(--privacy)}
  .tab-btn[data-tab="block"].active{border-bottom-color:var(--block)}
  .tab-btn[data-tab="clear"].active{border-bottom-color:var(--advanced)}
  .tab-btn[data-tab="import"].active{border-bottom-color:var(--import)}
  .content{padding:40px;display:none}
  .content.active{display:block}
  .section{margin-bottom:36px;background:rgba(255,255,255,.06);padding:32px;border-radius:20px;
    border:1px solid rgba(255,255,255,.12);transition:all .4s;position:relative;overflow:hidden}
  .section::before{content:"";position:absolute;top:0;left:0;width:6px;height:100%}
  .section:hover{transform:translateY(-6px);box-shadow:0 20px 50px rgba(0,0,0,.6)}
  .section h3{font-size:1.7rem;font-weight:700;margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;color:inherit;position:relative}
  .section h3::after{content:"";position:absolute;bottom:-8px;left:0;width:80px;height:4px;background:currentColor;border-radius:2px;opacity:0.6;filter:blur(8px);transition:all .4s}
  #core .section::before{background:var(--core)} #core h3{color:var(--core)}
  #time .section::before{background:var(--time)} #time h3{color:var(--time)}
  #privacy .section::before{background:var(--privacy)} #privacy h3{color:var(--privacy)}
  #block .section::before{background:var(--block)} #block h3{color:var(--block)}
  #clear .section::before{background:var(--advanced)} #clear h3{color:var(--advanced)}
  #import .section::before{background:var(--import)} #import h3{color:var(--import)}
  .feature-toggle{float:right}
  .switch{position:relative;display:inline-block;width:64px;height:36px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;inset:0;background:#475569;border-radius:34px;transition:.4s;cursor:pointer}
  .slider:before{position:absolute;content:"";height:28px;width:28px;left:4px;bottom:4px;background:white;border-radius:50%;transition:.4s}
  input:checked+.slider{background:#10b981}
  input:checked+.slider:before{transform:translateX(28px)}
  .input-group{margin:24px 0}
  label{display:block;margin-bottom:10px;font-weight:600}
  input[type="text"], input[type="number"], textarea{
    width:100%;padding:16px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);
    border-radius:14px;color:white;font-size:1rem;transition:all .3s}
  .btn{padding:14px 32px;border:none;border-radius:14px;font-weight:700;cursor:pointer;transition:all .35s;
    display:inline-flex;align-items:center;gap:10px;margin:10px 6px 10px 0}
  .btn:hover{transform:translateY(-4px)}
  #core .btn{background:var(--core);box-shadow:0 8px 30px rgba(59,130,246,.6)}
  #time .btn{background:var(--time);box-shadow:0 8px 30px rgba(251,146,60,.6)}
  #privacy .btn{background:var(--privacy);box-shadow:0 8px 30px rgba(167,139,250,.6)}
  #block .btn{background:var(--block);box-shadow:0 8px 30px rgba(239,68,68,.6)}
  #clear .btn{background:var(--advanced);box-shadow:0 8px 30px rgba(245,158,11,.6)}
  #import .btn{background:var(--import);box-shadow:0 8px 30px rgba(16,185,129,.6)}
  .item{padding:18px;background:rgba(255,255,255,.08);border-radius:14px;display:flex;justify-content:space-between;align-items:center;
    border-left:5px solid currentColor;transition:.3s;gap:12px}
  .item:hover{transform:translateX(6px)}
  .toggle-btn{font-size:1.4rem;cursor:pointer;color:#fbbf24;transition:.3s}
  .toggle-btn.active{color:#10b981}
  .remove{color:#ef4444;cursor:pointer;font-size:1.4rem;transition:.3s}
  .remove:hover{transform:scale(1.5) rotate(90deg)}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0}
  .stat-card{background:rgba(255,255,255,.08);padding:20px;border-radius:16px;text-align:center;border-left:5px solid currentColor}
  .stat-card h4{font-size:1.1rem;margin-bottom:8px;opacity:0.9}
  .stat-card span{font-size:2rem;font-weight:800}
  .graph-bar{height:26px;background:rgba(255,255,255,.1);border-radius:12px;overflow:hidden;margin:16px 0;position:relative}
  .fill{height:100%;border-radius:12px;transition:width .8s ease}
  .score{font-size:2.2rem;font-weight:800;text-align:center;margin:20px 0;background:linear-gradient(135deg,#a78bfa,#e879f9);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .site-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);padding:14px;border-radius:12px;text-align:center;cursor:pointer;transition:.3s;margin:8px}
  .site-btn:hover{background:rgba(167,139,250,.3);transform:translateY(-2px)}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Bulwark Settings</h1>
    <p>Full power in your hands</p>
  </header>
  <div class="tabs">
    <button class="tab-btn active" data-tab="core">Core Protection</button>
    <button class="tab-btn" data-tab="time">Time Restrictions</button>
    <button class="tab-btn" data-tab="privacy">Privacy Analysis</button>
    <button class="tab-btn" data-tab="block">Site Blocker</button>
    <button class="tab-btn" data-tab="clear">Data Clear</button>
    <button class="tab-btn" data-tab="import">Import/Export</button>
  </div>

    <!-- CORE PROTECTION -->
  <div id="core" class="content active">
    <div class="section">
      <h3>
        Core Protection 
        <label class="switch feature-toggle">
          <input type="checkbox" id="coreProtectionToggle" checked>
          <span class="slider"></span>
        </label>
      </h3>

      <div class="stats-grid">
        <!-- Phishing Blocked -->
        <div class="stat-card" style="border-left-color:#3b82f6">
          <h4>Phishing Sites Blocked</h4>
          <span id="phishingBlocked">47</span>
        </div>

        <!-- Permanently Blocked Sites -->
        <div class="stat-card" style="border-left-color:#ef4444">
          <h4>Permanently Blocked Sites</h4>
          <span id="blockedSitesCount">12</span>
        </div>

        <!-- Sites with Time Limits -->
        <div class="stat-card" style="border-left-color:#fb923c">
          <h4>Sites with Time Limits</h4>
          <span id="timeLimitedSites">8</span>
        </div>

        <!-- Privacy Scans Performed -->
        <div class="stat-card" style="border-left-color:#a78bfa">
          <h4>Privacy Scans Performed</h4>
          <span id="privacyScansCount">124</span>
        </div>

        <!-- Ads Blocked (NEW) -->
        <div class="stat-card" style="border-left-color:#10b981">
          <h4>Ads Blocked</h4>
          <span id="adsBlockedCount" style="font-size:2.4rem; color:#10b981">0</span>
        </div>
      </div>

    </div>
  </div>


  </div>

  <!-- TIME RESTRICTIONS -->
  <!-- TIME RESTRICTIONS -->
  <div id="time" class="content">
    <div class="section">
      <h3>Time Restrictions <label class="switch feature-toggle"><input type="checkbox" id="timeMasterToggle" checked><span class="slider"></span></label></h3>
      
      <div class="input-group">
        <label>Global Daily Limit (minutes)</label>
        <input type="number" id="globalTimeLimit" placeholder="120" min="1" max="1440">
        <small style="color: var(--muted); display: block; margin-top: 5px;">Set to 0 or empty to disable global limit</small>
      </div>
      
      <div class="input-group">
        <label>Warning Message</label>
        <input type="text" id="warningMessage" value="Your daily browsing time is over! Take a break." maxlength="200">
        <small style="color: var(--muted); display: block; margin-top: 5px;">Message shown when time limit is reached</small>
      </div>

      <h3 style="margin-top:40px">Per-Site Limits</h3>
      
      <div class="input-group">
        <label>Add site (e.g., facebook.com)</label>
        <input type="text" id="siteUrl" placeholder="facebook.com">
        <small style="color: var(--muted); display: block; margin-top: 5px;">Enter domain only, without http://</small>
      </div>
      
      <div class="input-group">
        <label>Minutes per day</label>
        <input type="number" id="siteMins" placeholder="30" min="1" max="1440">
      </div>
      
      <button class="btn" id="addSiteLimit">Add Site Limit</button>
      
      <div id="siteLimitError" style="color: #ef4444; margin: 10px 0; display: none;"></div>
      
      <div class="restrictions-list" id="siteLimitsList" style="margin-top:30px">
        <!-- Dynamic content will be inserted here -->
      </div>
      
      <button class="btn" style="margin-top:20px" id="saveTimeSettings">Save All Time Settings</button>
      <div id="saveStatus" style="margin-top: 10px;"></div>
    </div>
  </div>
  <!-- PRIVACY ANALYSIS -->
<div id="privacy" class="content">
  <div class="section">
    <h3>Privacy Analysis <label class="switch feature-toggle"><input type="checkbox" id="privacyMasterToggle" checked><span class="slider"></span></label></h3>
    
    <p style="margin:20px 0;color:var(--muted)">Bulwark automatically scans privacy policies and reports data collection practices.</p>
    
    <h3>Privacy Analysis Results</h3>
    <div class="score" id="overallPrivacyScore">Overall Privacy Score: Loading...</div>
    
    <div id="privacyGraphs">
      <div class="graph-bar"><div class="fill" id="dataCollectionBar" style="width:0%;background:#ef4444"></div></div><span id="dataCollectionText">Data Collection: Loading...</span>
      <div class="graph-bar"><div class="fill" id="dataUsageBar" style="width:0%;background:#f59e0b"></div></div><span id="dataUsageText">Data Usage: Loading...</span>
      <div class="graph-bar"><div class="fill" id="dataSharingBar" style="width:0%;background:#10b981"></div></div><span id="dataSharingText">Data Sharing: Loading...</span>
    </div>
    
    <h3 style="margin-top:40px">Recently Analyzed Sites</h3>
    <div class="site-list" id="analyzedSitesList">
      <!-- Dynamic content will be inserted here -->
    </div>
    
    <div style="margin-top:20px;color:var(--muted)">
      Sites analyzed today: <strong id="dailyAnalyzedCount">0</strong>
    </div>
  </div>
</div>

  <!-- SITE BLOCKER -->
  <div id="block" class="content">
    <div class="section">
      <h3>Site Blocker <label class="switch feature-toggle"><input type="checkbox" checked><span class="slider"></span></label></h3>
      <div class="input-group"><label>Block a website</label><input type="text" id="blockSite" placeholder="example.com"></div>
      <button class="btn" id="addBlocked">Block Site</button>
     <div class="blocked-list" id="blockedSitesList" style="margin-top:30px">
        <div class="item"><span>instagram.com</span><i class="fas fa-toggle-on toggle-btn active"></i><i class="fas fa-trash remove"></i></div>
        <div class="item"><span>tiktok.com</span><i class="fas fa-toggle-off toggle-btn"></i><i class="fas fa-trash remove"></i></div>
      </div>
    </div>
  </div>

  <!-- DATA CLEAR -->
  <div id="clear" class="content">
    <div class="section">
      <h3>Data Management</h3>
      <button class="btn">Reset All Data (Irreversible)</button>
      <button class="btn">Clear Activity Logs Only</button>
    </div>
  </div>

  <!-- IMPORT/EXPORT -->
  <div id="import" class="content">
    <div class="section">
      <h3>Import</h3>
      <button class="btn">Import Settings</button>
    </div>
  </div>
</div>

<script>
  // Load Ad Blocker Stats
async function loadAdBlockStats() {
  try {
    const response = await chrome.runtime.sendMessage({ action: "get_adblocker_stats" });
    if (response?.success) {
      document.getElementById('adsBlockedCount').textContent = response.data.adsBlocked;
      document.getElementById('trackersBlockedCount').textContent = response.data.trackersBlocked;
    }
  } catch (err) {
    console.log("Ad stats not ready yet");
  }
}
document.querySelector('[data-tab="core"]').addEventListener('click', () => {
  setTimeout(() => {
    loadAdBlockStats(); // Refresh instantly
  }, 200);
});

// Call on load + refresh every 3 seconds
loadAdBlockStats();
setInterval(loadAdBlockStats, 3000);
// Global variable to store current site limits
let currentSiteLimits = [];

// Tab switching
document.querySelectorAll('.tab-btn').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn,.content').forEach(el => el.classList.remove('active'));
    b.classList.add('active');
    document.getElementById(b.dataset.tab).classList.add('active');
   
    // Load data when switching tabs
    if (b.dataset.tab === 'time') {
      loadTimeSettings();
    }
    if (b.dataset.tab === 'block') {     // ← ADD THIS LINE
      loadBlockedSites();                // ← AND THIS ONE
    }
    if (b.dataset.tab === 'privacy') {
      setTimeout(loadPrivacyAnalysisData, 100);
    }
  });
});

// Toggle buttons in lists (for non-time restriction toggles)
document.addEventListener('click', e => {
  if (e.target.classList.contains('toggle-btn') && !e.target.closest('#siteLimitsList')) {
    e.target.classList.toggle('fa-toggle-on');
    e.target.classList.toggle('fa-toggle-off');
    e.target.classList.toggle('active');
  }
});

// Privacy graph // Privacy Analysis functionality for settings
function updateGraph(personal, tracking, sharing, site) {
  const fills = document.querySelectorAll('.fill');
  if (fills.length >= 3) {
    fills[0].style.width = personal + '%';
    fills[1].style.width = tracking + '%';
    fills[2].style.width = sharing + '%';
  }
  const scoreElement = document.querySelector('.score');
  if (scoreElement) {
    scoreElement.textContent = `Privacy Score for ${site}: ${Math.round((100-personal+100-tracking+100-sharing)/3)}%`;
  }
}

function loadPrivacyAnalysisData() {
  chrome.runtime.sendMessage({action: "get_privacy_stats"}, response => {
    if (response && response.success) {
      updatePrivacyAnalysisUI(response.data);
    } else {
      console.error('Failed to load privacy analysis data');
    }
  });
}

function updatePrivacyAnalysisUI(data) {
  // Update overall score
  const overallScore = data.overallPrivacyScore || 0;
  document.getElementById('overallPrivacyScore').textContent = 
    `Overall Privacy Score: ${overallScore}%`;
  
  // Update daily analyzed count
  document.getElementById('dailyAnalyzedCount').textContent = data.dailyAnalyzed || 0;
  
  // Update graphs with average data from stored sites
  updatePrivacyGraphs(data.storedSites);
  
  // Update analyzed sites list
  updateAnalyzedSitesList(data.storedSites);
}

function updatePrivacyGraphs(storedSites) {
  if (!storedSites || storedSites.length === 0) {
    // Show default/empty state
    document.getElementById('dataCollectionBar').style.width = '0%';
    document.getElementById('dataUsageBar').style.width = '0%';
    document.getElementById('dataSharingBar').style.width = '0%';
    
    document.getElementById('dataCollectionText').textContent = 'Data Collection: No data';
    document.getElementById('dataUsageText').textContent = 'Data Usage: No data';
    document.getElementById('dataSharingText').textContent = 'Data Sharing: No data';
    return;
  }
  
  // Calculate averages
  let totalCollection = 0;
  let totalUsage = 0;
  let totalSharing = 0;
  
  storedSites.forEach(site => {
    if (site.analysis) {
      totalCollection += site.analysis.dataCollection?.score || 0;
      totalUsage += site.analysis.dataUsage?.score || 0;
      totalSharing += site.analysis.dataSharing?.score || 0;
    }
  });
  
  const avgCollection = Math.round(totalCollection / storedSites.length);
  const avgUsage = Math.round(totalUsage / storedSites.length);
  const avgSharing = Math.round(totalSharing / storedSites.length);
  
  // Update bars
  document.getElementById('dataCollectionBar').style.width = avgCollection + '%';
  document.getElementById('dataUsageBar').style.width = avgUsage + '%';
  document.getElementById('dataSharingBar').style.width = avgSharing + '%';
  
  // Update texts
  document.getElementById('dataCollectionText').textContent = 
    `Data Collection: ${avgCollection}% - ${getRiskLevel(avgCollection)}`;
  document.getElementById('dataUsageText').textContent = 
    `Data Usage: ${avgUsage}% - ${getRiskLevel(avgUsage)}`;
  document.getElementById('dataSharingText').textContent = 
    `Data Sharing: ${avgSharing}% - ${getRiskLevel(avgSharing)}`;
}

function getRiskLevel(score) {
  if (score >= 70) return 'High Risk';
  if (score >= 40) return 'Medium Risk';
  return 'Low Risk';
}

function updateAnalyzedSitesList(storedSites) {
  const container = document.getElementById('analyzedSitesList');
  container.innerHTML = '';
  
  if (!storedSites || storedSites.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">No sites analyzed yet</div>';
    return;
  }
  
  storedSites.forEach(site => {
    const siteBtn = document.createElement('div');
    siteBtn.className = 'site-btn';
    siteBtn.innerHTML = `
      <div style="font-weight:600">${site.domain}</div>
      <div style="font-size:0.9rem;color:${getScoreColor(site.overallScore)}">
        ${site.overallScore}% Privacy
      </div>
    `;
    siteBtn.onclick = () => showSitePrivacyDetails(site);
    container.appendChild(siteBtn);
  });
}

function getScoreColor(score) {
  if (score >= 80) return 'var(--green)';
  if (score >= 60) return '#f59e0b';
  return 'var(--red)';
}

function showSitePrivacyDetails(site) {
  // Update graphs with specific site data
  if (site.analysis) {
    document.getElementById('dataCollectionBar').style.width = site.analysis.dataCollection?.score + '%';
    document.getElementById('dataUsageBar').style.width = site.analysis.dataUsage?.score + '%';
    document.getElementById('dataSharingBar').style.width = site.analysis.dataSharing?.score + '%';
    
    document.getElementById('dataCollectionText').textContent = 
      `Data Collection: ${site.analysis.dataCollection?.score}%`;
    document.getElementById('dataUsageText').textContent = 
      `Data Usage: ${site.analysis.dataUsage?.score}%`;
    document.getElementById('dataSharingText').textContent = 
      `Data Sharing: ${site.analysis.dataSharing?.score}%`;
  }
}

// Load privacy data when privacy tab is activated
document.querySelector('[data-tab="privacy"]').addEventListener('click', () => {
  setTimeout(loadPrivacyAnalysisData, 100);
});

// Also load if privacy tab is active on page load
if (document.getElementById('privacy').classList.contains('active')) {
  setTimeout(loadPrivacyAnalysisData, 100);
}

// ==================== TIME RESTRICTIONS FUNCTIONALITY ====================
document.addEventListener('DOMContentLoaded', function() {
  initializeTimeRestrictions();
  loadBlockedSites();
});

function initializeTimeRestrictions() {
  try {
    console.log('Initializing time restrictions...');
    
    // Load current settings when page loads
    if (document.getElementById('time').classList.contains('active')) {
      loadTimeSettings();
    }
    
    // Add event listeners
    const addSiteLimitBtn = document.getElementById('addSiteLimit');
    const saveTimeSettingsBtn = document.getElementById('saveTimeSettings');
    const timeMasterToggle = document.getElementById('timeMasterToggle');
    
    if (addSiteLimitBtn) {
      addSiteLimitBtn.addEventListener('click', addSiteLimit);
    }
    if (saveTimeSettingsBtn) {
      saveTimeSettingsBtn.addEventListener('click', saveAllTimeSettings);
    }
    if (timeMasterToggle) {
      timeMasterToggle.addEventListener('change', toggleTimeRestrictions);
    }
    
    // Input validation
    const siteUrlInput = document.getElementById('siteUrl');
    const siteMinsInput = document.getElementById('siteMins');
    const globalLimitInput = document.getElementById('globalTimeLimit');
    
    if (siteUrlInput) siteUrlInput.addEventListener('input', clearErrors);
    if (siteMinsInput) siteMinsInput.addEventListener('input', clearErrors);
    if (globalLimitInput) globalLimitInput.addEventListener('input', clearErrors);
    
  } catch (error) {
    console.error('Error initializing time restrictions:', error);
    showError('siteLimitError', 'Failed to initialize time restrictions');
  }
}

function loadTimeSettings() {
  console.log('Loading time settings...');
  
  // Try to load from Chrome storage first, fall back to empty data
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({action: "time_getStats"}, response => {
      if (response && response.success) {
        currentSiteLimits = response.data.siteLimits || [];
        updateTimeUI(response.data);
      } else {
        // Use empty data if Chrome API fails
        const emptyData = {
          globalUsed: 0,
          globalLimit: null,
          siteLimits: [],
          enabled: false,
          warningMessage: "Your daily browsing time is over! Take a break."
        };
        currentSiteLimits = [];
        updateTimeUI(emptyData);
      }
    });
  } else {
    // No Chrome API - use currentSiteLimits (starts empty)
    const emptyData = {
      globalUsed: 0,
      globalLimit: null,
      siteLimits: currentSiteLimits,
      enabled: false,
      warningMessage: "Your daily browsing time is over! Take a break."
    };
    updateTimeUI(emptyData);
  }
}

function updateTimeUI(data) {
  try {
    console.log('Updating time UI with data:', data);
    
    if (!data) {
      console.error('No data provided to updateTimeUI');
      return;
    }

    // Update global limit
    const globalLimitInput = document.getElementById('globalTimeLimit');
    if (globalLimitInput) {
      globalLimitInput.value = data.globalLimit || '';
    }
    
    // Update warning message
    const warningInput = document.getElementById('warningMessage');
    if (warningInput) {
      warningInput.value = data.warningMessage || "Your daily browsing time is over! Take a break.";
    }
    
    // Update master toggle
    const masterToggle = document.getElementById('timeMasterToggle');
    if (masterToggle) {
      masterToggle.checked = data.enabled || false;
    }
    
    // Update site limits list
    updateSiteLimitsList(data.siteLimits || []);
    
  } catch (error) {
    console.error('Error updating time UI:', error);
    showError('siteLimitError', 'Error displaying time settings');
  }
}

function updateSiteLimitsList(siteLimits) {
  const container = document.getElementById('siteLimitsList');
  if (!container) {
    console.error('siteLimitsList container not found!');
    return;
  }
  
  try {
    console.log('Updating site limits list with:', siteLimits);
    
    // Update the global state
    currentSiteLimits = siteLimits;
    
    // Always clear the container first
    container.innerHTML = '';
    
    if (!siteLimits || siteLimits.length === 0) {
      container.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No site limits added yet</div>';
      console.log('No site limits to display');
      return;
    }
    
    siteLimits.forEach(site => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <span>
          <strong>${escapeHtml(site.site)}</strong><br>
          ${site.limit} min/day • Used: ${site.used || 0} min • ${site.enabled ? 'Enabled' : 'Disabled'}
        </span>
        <div>
          <i class="fas ${site.enabled ? 'fa-toggle-on' : 'fa-toggle-off'} toggle-btn ${site.enabled ? 'active' : ''}" 
             data-site="${escapeHtml(site.site)}" title="${site.enabled ? 'Disable' : 'Enable'}"></i>
          <i class="fas fa-trash remove" data-site="${escapeHtml(site.site)}" title="Remove"></i>
        </div>
      `;
      container.appendChild(div);
    });
    
    console.log('Added ' + siteLimits.length + ' site limits to the list');
    
    // Add event listeners for toggle and remove buttons
    container.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const site = this.dataset.site;
        const enabled = !this.classList.contains('active');
        console.log('Toggling site limit:', site, 'to', enabled);
        toggleSiteLimit(site, enabled);
      });
    });
    
    container.querySelectorAll('.remove').forEach(btn => {
      btn.addEventListener('click', function() {
        const site = this.dataset.site;
        console.log('Removing site limit:', site);
        if (confirm(`Are you sure you want to remove time limit for ${site}?`)) {
          removeSiteLimit(site);
        }
      });
    });
    
  } catch (error) {
    console.error('Error updating site limits list:', error);
    showError('siteLimitError', 'Error displaying site limits');
  }
}

function addSiteLimit() {
  console.log('Add site limit clicked');
  
  const urlInput = document.getElementById('siteUrl');
  const minsInput = document.getElementById('siteMins');
  
  if (!urlInput || !minsInput) {
    console.error('Input elements not found');
    return;
  }
  
  let site = urlInput.value.trim();
  const limit = minsInput.value.trim();
  
  console.log('Site:', site, 'Limit:', limit);
  
  // Validation
  if (!site) {
    showError('siteLimitError', 'Please enter a site URL');
    urlInput.focus();
    return;
  }
  
  if (!limit || isNaN(limit) || parseInt(limit) <= 0) {
    showError('siteLimitError', 'Please enter a valid time limit (positive number)');
    minsInput.focus();
    return;
  }
  
  // Improved domain validation and normalization
  try {
    // Remove http://, https://, and www. prefixes
    site = site.replace(/^(https?:\/\/)?(www\.)?/, '');
    
    // Remove any paths after the domain
    site = site.split('/')[0];
    
    // Remove any port numbers
    site = site.split(':')[0];
    
    console.log('Normalized site:', site);
    
    // Check if it's a valid domain format
    const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
    
    if (!domainRegex.test(site) || !site.includes('.')) {
      showError('siteLimitError', 'Please enter a valid domain (e.g., "facebook.com" or "example.co.uk")');
      urlInput.focus();
      return;
    }
    
  } catch (error) {
    console.error('Error validating domain:', error);
    showError('siteLimitError', 'Invalid domain format');
    urlInput.focus();
    return;
  }
  
  clearErrors();
  
  // Check if site already exists
  const existingSiteIndex = currentSiteLimits.findIndex(s => s.site === site);
  if (existingSiteIndex !== -1) {
    showError('siteLimitError', `Site "${site}" already has a time limit`);
    urlInput.focus();
    return;
  }
  
  // Add the new site to current list
  const newSite = {
    site: site,
    limit: parseInt(limit),
    used: 0,
    enabled: true
  };
  
  currentSiteLimits.push(newSite);
  
  // Update the UI with the updated list
  updateSiteLimitsList(currentSiteLimits);
  urlInput.value = '';
  minsInput.value = '';
  showSuccess('Site limit added successfully');
  
  // Save to Chrome storage if available
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({
      action: "time_addSiteLimit",
      site: site,
      limit: limit
    });
  }
}

function toggleSiteLimit(site, enabled) {
  console.log('Toggling site limit:', site, 'to', enabled);
  
  // Update the site in current list
  const siteIndex = currentSiteLimits.findIndex(s => s.site === site);
  if (siteIndex !== -1) {
    currentSiteLimits[siteIndex].enabled = enabled;
    updateSiteLimitsList(currentSiteLimits);
    showSuccess(`Site limit ${enabled ? 'enabled' : 'disabled'} successfully`);
    
    // Save to Chrome storage if available
    if (typeof chrome !== 'undefined' && chrome.runtime) {
      chrome.runtime.sendMessage({
        action: "time_toggleSiteLimit",
        site: site,
        enabled: enabled
      });
    }
  }
}

function removeSiteLimit(site) {
  console.log('Removing site limit:', site);
  
  // Remove the site from current list
  currentSiteLimits = currentSiteLimits.filter(s => s.site !== site);
  
  // Update the UI with the updated list
  updateSiteLimitsList(currentSiteLimits);
  showSuccess('Site limit removed successfully');
  
  // Save to Chrome storage if available
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({
      action: "time_removeSiteLimit",
      site: site
    });
  }
}

function toggleTimeRestrictions() {
  const toggle = document.getElementById('timeMasterToggle');
  const globalLimitInput = document.getElementById('globalTimeLimit');
  
  if (!toggle || !globalLimitInput) return;
  
  console.log('Time restrictions toggled:', toggle.checked);
  
  if (!toggle.checked) {
    // Disabling - clear global limit
    globalLimitInput.value = '';
    updateGlobalLimit();
  }
  // Enabling happens when global limit is set
}

function updateGlobalLimit() {
  const limitInput = document.getElementById('globalTimeLimit');
  const messageInput = document.getElementById('warningMessage');
  
  if (!limitInput || !messageInput) return;
  
  const limit = limitInput.value ? parseInt(limitInput.value) : null;
  const message = messageInput.value.trim();
  
  console.log('Updating global limit:', limit, 'Message:', message);
  
  if (limit && (limit < 1 || limit > 1440)) {
    showError('siteLimitError', 'Global limit must be between 1 and 1440 minutes');
    return;
  }
  
  showSuccess('Global limit updated successfully');
  
  // Save to Chrome storage if available
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({
      action: "time_updateGlobalLimit",
      limit: limit,
      message: message
    });
  }
}

function saveAllTimeSettings() {
  console.log('Saving all time settings');
  updateGlobalLimit();
}

function clearErrors() {
  const errorElement = document.getElementById('siteLimitError');
  if (errorElement) {
    errorElement.style.display = 'none';
  }
  const statusElement = document.getElementById('saveStatus');
  if (statusElement) {
    statusElement.innerHTML = '';
  }
}

function showError(elementId, message) {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = message;
    element.style.display = 'block';
    element.style.color = '#ef4444';
    console.error('Error:', message);
  }
}

function showSuccess(message) {
  const statusElement = document.getElementById('saveStatus');
  if (statusElement) {
    statusElement.textContent = message;
    statusElement.style.color = '#10b981';
    statusElement.style.display = 'block';
    console.log('Success:', message);
    
    setTimeout(() => {
      statusElement.style.display = 'none';
    }, 3000);
  }
}

function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Demo add blocked site (for site blocker tab)
document.getElementById('addBlocked')?.addEventListener('click', () => {
  const site = document.getElementById('blockSite').value.trim();
  if (!site) return;
  const div = document.createElement('div');
  div.className = 'item';
  div.innerHTML = `<span>${site}</span><i class="fas fa-toggle-on toggle-btn active"></i><i class="fas fa-trash remove"></i>`;
  document.getElementById('blockedSitesList').appendChild(div);
  document.getElementById('blockSite').value = '';
});

// Load time settings when page loads if time tab is active
if (document.getElementById('time').classList.contains('active')) {
  setTimeout(() => {
    loadTimeSettings();
  }, 100);
}
// In settings1.html - Privacy Analysis section
async function loadPrivacyStats() {
  try {
    const response = await new Promise((resolve) => {
      chrome.runtime.sendMessage({ action: "get_privacy_stats" }, resolve);
    });

    if (response.success) {
      updatePrivacyUI(response.data);
    }
  } catch (error) {
    console.error('Error loading privacy stats:', error);
  }
}

function updatePrivacyUI(data) {
  // Update overall score
  document.querySelector('.score').textContent = 
    `Overall Privacy Score: ${data.overallPrivacyScore}%`;

  // Update daily analyzed count
  const analyzedElement = document.querySelector('.analyzed-count');
  if (analyzedElement) {
    analyzedElement.textContent = data.dailyAnalyzed;
  }

  // Update stored sites list
  updateStoredSitesList(data.storedSites);

  // Update graphs with real data
  updatePrivacyGraphs(data.storedSites);
}

function updateStoredSitesList(sites) {
  const container = document.querySelector('.site-list');
  container.innerHTML = '';

  sites.forEach(site => {
    const siteElement = document.createElement('div');
    siteElement.className = 'site-btn';
    siteElement.innerHTML = `
      <div>${site.domain}</div>
      <div style="font-size: 0.8rem; color: ${getScoreColor(site.overallScore)}">
        ${site.overallScore}% Privacy
      </div>
    `;
    siteElement.onclick = () => showSiteDetails(site);
    container.appendChild(siteElement);
  });
}

function getScoreColor(score) {
  if (score >= 80) return '#10b981';
  if (score >= 60) return '#f59e0b';
  return '#ef4444';
}

function showSiteDetails(site) {
  // Update graphs with specific site data
  updateGraph(
    site.analysis.dataCollection.score,
    site.analysis.dataUsage.score,
    site.analysis.dataSharing.score,
    site.domain
  );
}

// Call this when privacy tab is activated
document.querySelector('[data-tab="privacy"]').addEventListener('click', () => {
  setTimeout(loadPrivacyStats, 100);
});
// ==================== SITE BLOCKER - FULLY WORKING ====================

async function loadBlockedSites() {
  const { blockedSites = [] } = await chrome.storage.local.get('blockedSites');
  const list = document.getElementById('blockedSitesList');
  list.innerHTML = '';

  if (blockedSites.length === 0) {
    list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">No sites blocked yet</div>';
    return;
  }

  blockedSites.forEach(site => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <span>${site}</span>
      <i class="fas fa-trash remove" data-site="${site}" title="Remove"></i>
    `;
    list.appendChild(div);
  });
}

// Add new blocked site
document.getElementById('addBlocked')?.addEventListener('click', async () => {
  let site = document.getElementById('blockSite').value.trim();
  if (!site) return alert('Please enter a website');

  site = site.toLowerCase()
    .replace(/^https?:\/\//, '')
    .replace(/^www\./, '')
    .split('/')[0]
    .split(':')[0];

  if (!site.includes('.') || site.length < 3) return alert('Invalid domain');

  const { blockedSites = [] } = await chrome.storage.local.get('blockedSites');
  if (blockedSites.includes(site)) return alert('Already blocked');

  blockedSites.push(site);
  await chrome.storage.local.set({ blockedSites });
  document.getElementById('blockSite').value = '';
  loadBlockedSites();
});

// Remove blocked site
document.getElementById('blockedSitesList')?.addEventListener('click', async e => {
  if (e.target.classList.contains('remove')) {
    const site = e.target.dataset.site;
    if (!confirm(`Unblock ${site}?`)) return;

    const { blockedSites = [] } = await chrome.storage.local.get('blockedSites');
    const filtered = blockedSites.filter(s => s !== site);
    await chrome.storage.local.set({ blockedSites: filtered });
    loadBlockedSites();
  }
});

// Optional: Allow pressing Enter in input
document.getElementById('blockSite')?.addEventListener('keypress', e => {
  if (e.key === 'Enter') document.getElementById('addBlocked').click();
});
</script>
</body>
</html>